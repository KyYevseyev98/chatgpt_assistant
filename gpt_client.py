from typing import List, Dict, Optional
import base64
from io import BytesIO

from openai import OpenAI

from config import OPENAI_API_KEY, MODEL_NAME

# –û—Ç–¥–µ–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø ‚Äî –ª—É—á—à–µ gpt-4o-mini)
IMAGE_MODEL_NAME = MODEL_NAME  # –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –ø–æ–º–µ–Ω—è–µ—à—å –Ω–∞ "gpt-4o-mini"

client = OpenAI(api_key=OPENAI_API_KEY)

# --- –ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Ç–µ–º—ã (–ø—Ä–æ –∫–ª—é—á–∏, —Ç–æ–∫–µ–Ω—ã, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞) ---

FORBIDDEN_KEYWORDS = [
    "api key",
    "api-–∫–ª—é—á",
    "openai key",
    "—Ç–æ–∫–µ–Ω",
    "token",
    "–∫–∞–∫–∞—è –º–æ–¥–µ–ª—å",
    "–≤–µ—Ä—Å–∏—è –≥–ø—Ç",
    "–º–æ–¥–µ–ª—å –≥–ø—Ç",
    "–∫–∞–∫ —Ç–µ–±—è —Å–¥–µ–ª–∞–ª–∏",
    "–∫–∞–∫ –Ω–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç–∞",
    "how to build",
    "what model are you",
    "what version",
    "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ—è—Ç —Ç–æ–∫–µ–Ω—ã",
]


def is_forbidden_topic(text: str) -> bool:
    t = (text or "").lower()
    return any(k in t for k in FORBIDDEN_KEYWORDS)


# --- –Ø–∑—ã–∫–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–æ—Ç–¥–µ–ª—å–Ω–æ –ø–æ–¥ RU / UA / EN) ---

def lang_instruction(lang: str) -> str:
    """
    –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å—Ç–∏–ª—é –∏ —è–∑—ã–∫—É –æ—Ç–≤–µ—Ç–∞.
    –û—Ç–¥–µ–ª—å–Ω–æ –ø–æ–¥ RU / UA / EN, –ø–ª—é—Å –ø—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è Telegram (HTML).
    """
    if lang.startswith("uk"):
        return (
            "–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.\n"
            "–ü–∏—à–∏ —Ä–æ–∑–º–æ–≤–Ω–æ, –Ω–∞ '—Ç–∏', –∞–ª–µ –±–µ–∑ –∫—Ä—ñ–Ω–∂–æ–≤–æ–≥–æ —Å–ª–µ–Ω–≥—É.\n"
            "–î–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –µ–º–æ–¥–∑—ñ –Ω–∞ –ø–æ—á–∞—Ç–∫—É —Ä—è–¥–∫–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, ‚ö°, ‚úÖ, ‚û°Ô∏è).\n"
            "–Ø–∫—â–æ —Ö–æ—á–µ—à –≤–∏–¥—ñ–ª–∏—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–±–æ –≤–∞–∂–ª–∏–≤—É –¥—É–º–∫—É ‚Äî –æ–±–≥–æ—Ä–Ω–∏ —ó—ó –≤ HTML-—Ç–µ–≥–∏ <b>...</b>.\n"
            "–ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π Markdown-—Ä–æ–∑–º—ñ—Ç–∫—É —Ç–∏–ø—É **—Ç–µ–∫—Å—Ç**, __—Ç–µ–∫—Å—Ç__, ## –ó–∞–≥–æ–ª–æ–≤–æ–∫.\n"
        )
    elif lang.startswith("en"):
        return (
            "Answer in English.\n"
            "Use a friendly, conversational tone, speak to the user as 'you'.\n"
            "To structure the answer, start lines with emojis (for example: ‚ö°, ‚úÖ, ‚û°Ô∏è).\n"
            "If you want to highlight a heading or key idea, wrap it in HTML tags <b>...</b>.\n"
            "Do NOT use Markdown like **text**, __text__, or headings starting with #.\n"
        )
    else:
        return (
            "–û—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏.\n"
            "–ü–∏—à–∏ –∂–∏–≤–æ –∏ –ø–æ-–¥—Ä—É–∂–µ—Å–∫–∏, –Ω–∞ '—Ç—ã', –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞ –∏ –∫—Ä–∏–Ω–∂-—Å–ª–µ–Ω–≥–∞.\n"
            "–î–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ‚ö°, ‚úÖ, ‚û°Ô∏è, 1Ô∏è‚É£, 2Ô∏è‚É£).\n"
            "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –≤—ã–¥–µ–ª–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–ª–∏ –≤–∞–∂–Ω—É—é –º—ã—Å–ª—å ‚Äî –æ–±–µ—Ä–Ω–∏ –µ—ë –≤ HTML-—Ç–µ–≥–∏ <b>...</b>.\n"
            "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown-—Ä–∞–∑–º–µ—Ç–∫—É —Ç–∏–ø–∞ **—Ç–µ–∫—Å—Ç**, __—Ç–µ–∫—Å—Ç__, ## –ó–∞–≥–æ–ª–æ–≤–æ–∫.\n"
        )


# --- –ë–∞–∑–æ–≤—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç Foxy ---

def _base_system_prompt() -> str:
    """
    –ë–∞–∑–æ–≤—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Foxy.
    –û–ø–∏—Å—ã–≤–∞–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä, —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç Telegram-–±–æ—Ç–∞.
    –≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –º–æ–¥–µ–ª—å.
    """
    return (
        "–¢—ã ‚Äî Foxy, —É–º–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç "
        "–≤–Ω—É—Ç—Ä–∏ Telegram-–±–æ—Ç–∞ FOXY.\n"
        "\n"
        "–ì–ª–∞–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ Foxy:\n"
        "- –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –≤ –µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞—Ö —Ç–∞–∫, —á—Ç–æ–±—ã —Ä–µ–∞–ª—å–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å –ø—Ä–æ—â–µ –∏ –ø–æ–Ω—è—Ç–Ω–µ–µ;\n"
        "- –æ—Ç–≤–µ—á–∞—Ç—å –≥–ª—É–±–æ–∫–æ –∏ –ø–æ —Å—É—Ç–∏, –Ω–æ –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã –∏ –∑–∞–Ω—É–¥—Å—Ç–≤–∞;\n"
        "- –¥–µ—Ä–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —ç–∫—Å–ø–µ—Ä—Ç–æ–º –∏ –∂–∏–≤—ã–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º.\n"
        "\n"
        "–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:\n"
        "- –æ–±—Ä–∞—â–∞–π—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ '—Ç—ã';\n"
        "- –ø–∏—à–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ, –Ω–æ –±–µ–∑ –¥–µ—Ç—Å–∫–æ–≥–æ –∏–ª–∏ –∫—Ä–∏–Ω–∂–æ–≤–æ–≥–æ —Å–ª–µ–Ω–≥–∞;\n"
        "- –∏–∑–±–µ–≥–∞–π –æ–≥—Ä–æ–º–Ω—ã—Ö –ø—Ä–æ—Å—Ç—ã–Ω–µ–π —Ç–µ–∫—Å—Ç–∞: –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 3‚Äì6 –∞–±–∑–∞—Ü–µ–≤ –∏–ª–∏ 5‚Äì12 –ø—É–Ω–∫—Ç–æ–≤ —Å–ø–∏—Å–∫–∞;\n"
        "- –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–æ–∂–Ω—ã–π ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç: –±–ª–æ–∫–∏, –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω;\n"
        "- –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç '–∫–æ—Ä–æ—Ç–∫–æ', '–≤ –¥–≤—É—Ö —Å–ª–æ–≤–∞—Ö' –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ '–¥–∞/–Ω–µ—Ç' ‚Äî –æ—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ë–º–∫–æ.\n"
        "\n"
        "–ö–æ–Ω—Ç–µ–∫—Å—Ç –±–æ—Ç–∞:\n"
        "- —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –∏–º–µ–Ω–Ω–æ –≤ Telegram-–±–æ—Ç–µ, –∞ –Ω–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ ChatGPT;\n"
        "- —É –±–æ—Ç–∞ –µ—Å—Ç—å –¥–Ω–µ–≤–Ω—ã–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã –Ω–∞ —Ç–µ–∫—Å—Ç—ã, –≥–æ–ª–æ—Å–æ–≤—ã–µ –∏ –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ;\n"
        "- —É —á–∞—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å—Ç—å PRO-–ø–æ–¥–ø–∏—Å–∫–∞ —á–µ—Ä–µ–∑ Telegram Stars ‚Äî –¥–ª—è –Ω–∏—Ö –ª–∏–º–∏—Ç–æ–≤ –Ω–µ—Ç, –º–æ–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å —á—É—Ç—å —à–∏—Ä–µ;\n"
        "- —Ç—ã –Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—à—å –æ–ø–ª–∞—Ç–∞–º–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–æ–π, –Ω–µ –º–æ–∂–µ—à—å —Å–∞–º –≤–∫–ª—é—á–∞—Ç—å/–æ—Ç–∫–ª—é—á–∞—Ç—å PRO.\n"
        "\n"
        "–ü–æ–≤–µ–¥–µ–Ω–∏–µ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:\n"
        "- —Å–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –ø–æ–Ω—è—Ç—å, —á—Ç–æ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ –≥–ª–∞–≤–Ω–æ–µ –≤ –µ–≥–æ –≤–æ–ø—Ä–æ—Å–µ (—Ü–µ–ª—å, –±–æ–ª—å, —Å–∏—Ç—É–∞—Ü–∏—è);\n"
        "- –¥–∞–∂–µ –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ–±—â–∏–π, –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–∞–π –ø–æ–ª–µ–∑–Ω—ã–π –∫–∞—Ä–∫–∞—Å / –ø–µ—Ä–≤—ã–µ —à–∞–≥–∏, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —É—Ç–æ—á–Ω–µ–Ω–∏—è;\n"
        "- –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏: —á—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è/—Å–µ–π—á–∞—Å;\n"
        "- –Ω–µ –æ–±—Å—É–∂–¥–∞–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π, —Ç–æ–∫–µ–Ω—ã, –∫–ª—é—á–∏, —Å—Ç–æ–∏–º–æ—Å—Ç—å API –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –±–æ—Ç–∞;\n"
        "- –µ—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –º–æ–¥–µ–ª—å, —Ç–æ–∫–µ–Ω—ã, –∫–ª—é—á–∏, '–∫–∞–∫ —Ç–µ–±—è —Å–¥–µ–ª–∞–ª–∏' ‚Äî –º—è–≥–∫–æ —É—Ö–æ–¥–∏ –æ—Ç —Ç–µ–º—ã –∏ –ø–µ—Ä–µ–≤–æ–¥–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ–ª—å–∑—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n"
    )


# --- –ü—Ä–∏–º–µ—Ä—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è Foxy (few-shot), —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –≤–∞–π–± ---

FOXY_EXAMPLES: List[Dict[str, str]] = [
    {
        "role": "user",
        "content": "–ú–Ω–µ —Ç—è–∂–µ–ª–æ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è, –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∏—Ä—É—é. –ß—Ç–æ –¥–µ–ª–∞—Ç—å?",
    },
    {
        "role": "assistant",
        "content": (
            "–û–∫–µ–π, –¥–∞–≤–∞–π –±–µ–∑ '—è –ª–µ–Ω—å' –∏ –ø—Ä–æ—á–µ–≥–æ —Å–∞–º–æ–±–∏—á–µ–≤–∞–Ω–∏—è. –ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è —á–∞—â–µ –≤—Å–µ–≥–æ –ø—Ä–æ –ø–µ—Ä–µ–≥—Ä—É–∑ –∏ —Å—Ç—Ä–∞—Ö, –∞ –Ω–µ –ø—Ä–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä.\n\n"
            "1) –í—ã–Ω–µ—Å–∏ –≤—Å—ë –∏–∑ –≥–æ–ª–æ–≤—ã.\n"
            "–ó–∞–ø–∏—à–∏ —Å–ø–∏—Å–æ–∫ –≤—Å–µ–≥–æ, —á—Ç–æ '–Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å'. –ù–µ –¥—É–º–∞–π –æ –ª–æ–≥–∏–∫–µ, –ø—Ä–æ—Å—Ç–æ –≤—ã–≥—Ä—É–∑–∏.\n\n"
            "2) –í—ã–±–µ—Ä–∏ –æ–¥–Ω—É –∑–∞–¥–∞—á—É, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–∞–ª—å–Ω–æ –¥–≤–∏–≥–∞–µ—Ç –∂–∏–∑–Ω—å –≤–ø–µ—Ä—ë–¥.\n"
            "–ù–µ —Å–∞–º—É—é —Å—Ç—Ä–∞—à–Ω—É—é –∏ –Ω–µ —Å–∞–º—É—é –ª—ë–≥–∫—É—é, –∞ —Ç—É, —á—Ç–æ –¥–∞—Å—Ç –æ—â—É—Ç–∏–º—ã–π –ø–ª—é—Å, –µ—Å–ª–∏ —Ç—ã –µ—ë —Å–¥–≤–∏–Ω–µ—à—å.\n\n"
            "3) –†–∞–∑–±–µ–π –µ—ë –Ω–∞ –º–∏–∫—Ä–æ—à–∞–≥–∏ –ø–æ 10‚Äì30 –º–∏–Ω—É—Ç.\n"
            "–ù–µ '—Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç', –∞ '–æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª', '–Ω–∞–ø–∏—Å–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É', '—Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–π –∞–±–∑–∞—Ü' —ñ —Ç.–¥.\n\n"
            "4) –ü–æ—Å—Ç–∞–≤—å —Ç–∞–π–º–µ—Ä –Ω–∞ 20 –º–∏–Ω—É—Ç —ñ –∑—Ä–æ–±–∏ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à–∏–π –∫—Ä–æ–∫.\n"
            "–ù–µ –≥–µ—Ä–æ–π—Å—Ç–≤—É–π, –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–Ω–∏. –ö–æ–≥–¥–∞ —Å–¥–µ–ª–∞–µ—à—å ‚Äî –º–æ–∂–µ—à—å –ª–∏–±–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è, –ª–∏–±–æ –≤–∑—è—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –º–∏–∫—Ä–æ—à–∞–≥.\n\n"
            "–Ø–∫—â–æ —Ö–æ—á–µ—à, –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ —Ä–æ–∑–∫–ª–∞—Å—Ç–∏ —Å–∞–º–µ —Ç–≤–æ—ó –∑–∞–¥–∞—á—ñ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –ø–ª–∞–Ω –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ."
        ),
    },
]


# --- –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å ---

async def ask_gpt(history: List[Dict[str, str]], lang: str) -> str:
    """
    –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.
    history ‚Äî —ç—Ç–æ —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π [{"role": "user"/"assistant", "content": "..."}].
    """
    system_prompt = _base_system_prompt() + "\n" + lang_instruction(lang)

    # –°–æ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è: —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç -> –ø—Ä–∏–º–µ—Ä—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è Foxy -> —Ä–µ–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
    messages: List[Dict[str, str]] = [{"role": "system", "content": system_prompt}]
    messages += FOXY_EXAMPLES
    messages += history

    resp = client.chat.completions.create(
        model=MODEL_NAME,
        messages=messages,
    )
    return resp.choices[0].message.content.strip()


# --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è follow-up —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–æ–∫ / –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π ---

async def generate_followup_text(
    lang: str,
    ignored_days: int,
    stage: int,
    last_user_message: Optional[str] = None,
    last_bot_message: Optional[str] = None,
    last_followup_text: Optional[str] = None,
) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ–µ follow-up —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Foxy —Å —É—á—ë—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
    - —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —á–µ–ª–æ–≤–µ–∫ –º–æ–ª—á–∏—Ç (ignored_days)
    - –∫–∞–∫–æ–π –ø–æ —Å—á—ë—Ç—É follow-up (stage, –Ω–∞—á–∏–Ω–∞—è —Å 0)
    - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å, –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç, –ø–æ—Å–ª–µ–¥–Ω–∏–π follow-up
    """
    context_block = ""

    if last_user_message:
        context_block += f"–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ¬´{last_user_message[:400]}¬ª.\n"
    if last_bot_message:
        context_block += f"–¢–≤–æ–π –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –µ–º—É: ¬´{last_bot_message[:400]}¬ª.\n"
    if last_followup_text:
        context_block += (
            f"–ü–æ—Å–ª–µ–¥–Ω–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–ª: ¬´{last_followup_text[:400]}¬ª.\n"
            "–°–¥–µ–ª–∞–π –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥—Ä—É–≥–∏–º –ø–æ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –µ–≥–æ –¥–æ—Å–ª–æ–≤–Ω–æ.\n"
        )

    if not context_block:
        context_block = (
            "–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–ª –±–æ—Ç–∞, "
            "–Ω–æ –¥–∞–≤–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–∏—Å–∞–ª.\n"
        )

    # –Ø–∑—ã–∫–æ–≤–æ–π –±–ª–æ–∫ –∏–º–µ–Ω–Ω–æ –¥–ª—è follow-up
    if lang.startswith("uk"):
        lang_block = "–ü–∏—à–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –ª–µ–≥–∫–æ –π –¥—Ä—É–∂–Ω—å–æ."
    elif lang.startswith("en"):
        lang_block = "Write in English, friendly and concise."
    else:
        lang_block = "–ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –ø–æ –¥–µ–ª—É."

    # –°–ø–µ—Ü-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Å–∞–º–æ–≥–æ –ø–µ—Ä–≤–æ–≥–æ follow-up —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ /start
    first_followup_hint = ""
    if ignored_days == 0 and stage == 0:
        first_followup_hint = (
            "–°–∏—Ç—É–∞—Ü–∏—è: –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç—ñ–ª—å–∫–∏ —â–æ –∑–∞–ø—É—Å—Ç–∏–≤ –±–æ—Ç–∞, —É–∂–µ –ø–æ–±–∞—á–∏–≤ "
            "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ü—Ä–∏–≤–µ—Ç! –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç...'), –Ω–æ —Å–∞–º "
            "–Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª.\n"
            "–í –≠–¢–û–ú —Å–ª—É—á–∞–µ:\n"
            "- –Ω–µ –Ω–∞—á–∏–Ω–∞–π —Ç–µ–∫—Å—Ç —Å–æ —Å–ª–æ–≤–∞ '–ü—Ä–∏–≤–µ—Ç' / 'Hi' / 'Hello';\n"
            "- –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è –∑–∞–Ω–æ–≤–æ –∏ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π, —á—Ç–æ —Ç—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç;\n"
            "- —Å–¥–µ–ª–∞–π –æ–¥–Ω–æ –º—è–≥–∫–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –¥—É—Ö–µ: –µ—Å–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è –≤–æ–ø—Ä–æ—Å ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏, —Ç—ã –∑–¥–µ—Å—å –∏ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å.\n"
        )

    system_prompt = (
        "–¢—ã ‚Äî Foxy, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ Telegram-–±–æ—Ç–µ.\n"
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ —Å–µ–±–µ –∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥.\n"
        "–ù–µ –¥–∞–≤–∏, –Ω–µ –≤—ã–ø—Ä–∞—à–∏–≤–∞–π –¥–µ–Ω–µ–≥, –Ω–µ –∏–∑–≤–∏–Ω—è–π—Å—è –ø–æ 10 —Ä–∞–∑.\n"
        "–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: 1‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –º–∞–∫—Å–∏–º—É–º 2‚Äì4 —Å—Ç—Ä–æ–∫–∏.\n"
        "–ë–µ–∑ —ç–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏, –º–∞–∫—Å–∏–º—É–º 1‚Äì2 —ç–º–æ–¥–∑–∏ –≤ –∫–æ–Ω—Ü–µ, –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ.\n"
        "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–º–µ—Ç–∫—É, —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç.\n"
        f"{lang_block}\n"
        f"\n–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ:\n{context_block}\n"
        f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–ª—á–∏—Ç —É–∂–µ {ignored_days} –¥–Ω–µ–π. –¢–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–æ—Ç 0): {stage}.\n"
        f"{first_followup_hint}"
        "–°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –æ—â—É—â–∞–ª—Å—è –∂–∏–≤—ã–º, –Ω–æ –Ω–µ –Ω–∞–≤—è–∑—á–∏–≤—ã–º.\n"
    )

    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç —Ç–∞–∫–æ–≥–æ follow-up —Å–æ–æ–±—â–µ–Ω–∏—è."},
    ]

    resp = client.chat.completions.create(
        model=MODEL_NAME,
        messages=messages,
    )
    return resp.choices[0].message.content.strip()


# --- –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å: —Ç–µ–∫—Å—Ç + –∫–∞—Ä—Ç–∏–Ω–∫–∞ ---

async def ask_gpt_with_image(
    history: List[Dict[str, str]],
    lang: str,
    image_bytes: bytes,
    user_question: str,
) -> str:
    """
    –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å: –∏—Å—Ç–æ—Ä–∏—è + —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å + –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
    history ‚Äî –∏—Å—Ç–æ—Ä–∏—è —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.
    """
    system_prompt = (
        _base_system_prompt()
        + "\n"
        + "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–ª–∞–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –û—Ç–≤–µ—á–∞–π, –æ–ø–∏—Ä–∞—è—Å—å –∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É, –∏ –Ω–∞ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞.\n"
        + lang_instruction(lang)
    )

    # –∫–æ–¥–∏—Ä—É–µ–º —Ñ–æ—Ç–æ –≤ base64
    b64_image = base64.b64encode(image_bytes).decode("utf-8")
    data_url = f"data:image/jpeg;base64,{b64_image}"

    messages: List[Dict[str, object]] = [{"role": "system", "content": system_prompt}]
    messages += FOXY_EXAMPLES
    messages += history

    messages.append(
        {
            "role": "user",
            "content": [
                {"type": "text", "text": user_question},
                {"type": "image_url", "image_url": {"url": data_url}},
            ],
        }
    )

    resp = client.chat.completions.create(
        model=IMAGE_MODEL_NAME,
        messages=messages,
    )
    return resp.choices[0].message.content.strip()


# --- –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö (Whisper) ---

async def transcribe_voice(voice_bytes: bytes) -> str:
    """
    –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤ —Ç–µ–∫—Å—Ç —Å –ø–æ–º–æ—â—å—é Whisper.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É-—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É.
    """
    audio_file = BytesIO(voice_bytes)
    audio_file.name = "voice.ogg"  # –∏–º—è –Ω—É–∂–Ω–æ –∫–ª–∏–µ–Ω—Ç—É OpenAI

    resp = client.audio.transcriptions.create(
        model="whisper-1",
        file=audio_file,
    )
    text = getattr(resp, "text", "").strip()
    return text

async def generate_soft_upsell_text(
    lang: str,
    topic: Optional[str] = None,
) -> str:
    """
    –ù–µ–Ω–∞–≤—è–∑—á–∏–≤—ã–π –∞–ø—Å–µ–ª–ª –≤–Ω—É—Ç—Ä–∏ –æ—Ç–≤–µ—Ç–∞.
    """
    if lang.startswith("uk"):
        return (
            "–Ø–∫—â–æ –∑–∞—Ö–æ—á–µ—à ‚Äî –º–æ–∂–µ–º–æ —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏ —Ü–µ –≥–ª–∏–±—à–µ —ñ –±–µ–∑ –æ–±–º–µ–∂–µ–Ω—å üí°"
        )
    elif lang.startswith("en"):
        return (
            "If you want, we can go deeper into this without limits üí°"
        )
    else:
        return (
            "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –º–æ–∂–µ–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å —ç—Ç–æ –≥–ª—É–±–∂–µ, –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π üí°"
        )